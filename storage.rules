rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get user's role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Get user's masjid from custom claims
    function getUserMasjid() {
      return request.auth.token.masjidId;
    }

    // Check if user is a super admin
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    // Check if user is a zakat admin
    function isZakatAdmin() {
      return isAuthenticated() && getUserRole() == 'zakat_admin';
    }

    // Check if user is an admin
    function isAdmin() {
      return isSuperAdmin() || isZakatAdmin();
    }

    // Validate file size (max 10MB)
    function isValidFileSize() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // Validate file size for large documents (max 25MB)
    function isValidLargeFileSize() {
      return request.resource.size < 25 * 1024 * 1024;
    }

    // Validate content type for documents
    function isValidDocumentType() {
      return request.resource.contentType.matches('application/pdf')
        || request.resource.contentType.matches('image/.*')
        || request.resource.contentType.matches('application/msword')
        || request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }

    // Validate content type for images only
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }

    // Validate content type for ID documents (images and PDFs)
    function isValidIdDocumentType() {
      return request.resource.contentType.matches('application/pdf')
        || request.resource.contentType.matches('image/.*');
    }

    // ============================================
    // APPLICATION DOCUMENTS
    // Path: applications/{applicationId}/documents/{documentType}/{filename}
    // Document types: photo_id, ssn_card, lease_agreement, proof_of_income, other
    // ============================================
    match /applications/{applicationId}/documents/{documentType}/{filename} {
      // Anyone authenticated can read application documents
      // Firestore rules handle fine-grained access
      allow read: if isAuthenticated();

      // Applicants can upload documents to their applications
      // Must be valid file type and size
      allow create: if isAuthenticated()
        && isValidFileSize()
        && isValidDocumentType();

      // Only admins can delete documents
      allow delete: if isAdmin();

      // Documents cannot be updated (upload new version with different filename)
      allow update: if false;
    }

    // ============================================
    // APPLICATION DOCUMENT REQUESTS
    // Path: applications/{applicationId}/requested/{requestId}/{filename}
    // For documents uploaded in response to admin requests
    // ============================================
    match /applications/{applicationId}/requested/{requestId}/{filename} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && isValidFileSize()
        && isValidDocumentType();

      allow delete: if isAdmin();

      allow update: if false;
    }

    // ============================================
    // USER PROFILE IMAGES
    // Path: users/{userId}/profile/{filename}
    // ============================================
    match /users/{userId}/profile/{filename} {
      // Users can read their own profile images
      // Admins can read any profile images
      allow read: if isOwner(userId) || isAdmin();

      // Users can upload their own profile images
      allow create, update: if isOwner(userId)
        && isValidFileSize()
        && isValidImageType();

      // Users can delete their own profile images
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ============================================
    // USER ID DOCUMENTS (sensitive)
    // Path: users/{userId}/id_documents/{filename}
    // For storing verified ID documents separately
    // ============================================
    match /users/{userId}/id_documents/{filename} {
      // Only the owner and admins can read ID documents
      allow read: if isOwner(userId) || isAdmin();

      // Users can upload their own ID documents
      allow create: if isOwner(userId)
        && isValidFileSize()
        && isValidIdDocumentType();

      // Only admins can delete ID documents (after verification)
      allow delete: if isAdmin();

      // ID documents cannot be updated once uploaded
      allow update: if false;
    }

    // ============================================
    // MASJID ASSETS
    // Path: masjids/{masjidId}/assets/{assetType}/{filename}
    // Asset types: logo, banner, documents
    // ============================================
    match /masjids/{masjidId}/assets/{assetType}/{filename} {
      // Anyone authenticated can read masjid assets (logos, etc.)
      allow read: if isAuthenticated();

      // Only super admins can upload masjid assets
      allow create, update, delete: if isSuperAdmin();
    }

    // ============================================
    // MASJID DOCUMENTS (internal)
    // Path: masjids/{masjidId}/documents/{filename}
    // For internal masjid documents
    // ============================================
    match /masjids/{masjidId}/documents/{filename} {
      // Only admins can read masjid documents
      allow read: if isAdmin();

      // Only super admins can manage masjid documents
      allow create, update, delete: if isSuperAdmin();
    }

    // ============================================
    // SYSTEM ASSETS
    // Path: system/{assetType}/{filename}
    // For system-wide assets like email templates, etc.
    // ============================================
    match /system/{assetType}/{filename} {
      // Anyone authenticated can read system assets
      allow read: if isAuthenticated();

      // Only super admins can manage system assets
      allow create, update, delete: if isSuperAdmin();
    }

    // ============================================
    // TEMP UPLOADS
    // Path: temp/{userId}/{filename}
    // For temporary uploads before processing
    // Auto-cleanup via lifecycle rules
    // ============================================
    match /temp/{userId}/{filename} {
      // Users can read their own temp files
      allow read: if isOwner(userId);

      // Users can upload temp files
      allow create: if isOwner(userId)
        && isValidLargeFileSize();

      // Users can delete their own temp files
      allow delete: if isOwner(userId);

      // Temp files cannot be updated
      allow update: if false;
    }

    // ============================================
    // DEFAULT: DENY ALL
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
