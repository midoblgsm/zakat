rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get user's role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }

    // Get user's masjid from custom claims
    function getUserMasjid() {
      return request.auth.token.masjidId;
    }

    // Check if user is a super admin
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }

    // Check if user is a zakat admin
    function isZakatAdmin() {
      return isAuthenticated() && getUserRole() == 'zakat_admin';
    }

    // Check if user is an admin (super_admin or zakat_admin)
    function isAdmin() {
      return isSuperAdmin() || isZakatAdmin();
    }

    // Check if user is a zakat admin for a specific masjid
    function isZakatAdminForMasjid(masjidId) {
      return isZakatAdmin() && getUserMasjid() == masjidId;
    }

    // Validate required string field
    function isValidString(field) {
      return field is string && field.size() > 0;
    }

    // Validate email format (basic check)
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }

    // Validate phone format (basic - allows various formats)
    function isValidPhone(phone) {
      return phone is string && phone.size() >= 10;
    }

    // Validate application status value
    function isValidApplicationStatus(status) {
      return status in ['draft', 'submitted', 'under_review', 'pending_documents',
                        'pending_verification', 'approved', 'rejected', 'disbursed', 'closed'];
    }

    // Validate application status transition
    function isValidStatusTransition(oldStatus, newStatus) {
      // Define valid transitions
      return (oldStatus == 'draft' && newStatus in ['submitted']) ||
             (oldStatus == 'submitted' && newStatus in ['under_review', 'rejected']) ||
             (oldStatus == 'under_review' && newStatus in ['pending_documents', 'pending_verification', 'approved', 'rejected']) ||
             (oldStatus == 'pending_documents' && newStatus in ['under_review', 'rejected', 'closed']) ||
             (oldStatus == 'pending_verification' && newStatus in ['approved', 'rejected', 'under_review']) ||
             (oldStatus == 'approved' && newStatus in ['disbursed', 'closed']) ||
             (oldStatus == 'rejected' && newStatus in ['closed']) ||
             (oldStatus == 'disbursed' && newStatus in ['closed']);
    }

    // Validate flag severity
    function isValidFlagSeverity(severity) {
      return severity in ['warning', 'blocked'];
    }

    // Validate notification type
    function isValidNotificationType(type) {
      return type in ['application_submitted', 'application_assigned', 'application_released',
                      'status_update', 'document_requested', 'application_approved',
                      'application_rejected', 'new_application_in_pool', 'system_announcement'];
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read any user profile
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own profile during registration
      // The profile must have their own UID
      allow create: if isOwner(userId)
        && request.resource.data.id == userId
        && request.resource.data.role == 'applicant'
        && isValidEmail(request.resource.data.email);

      // Users can update their own profile (limited fields)
      // Admins can update any profile
      allow update: if (isOwner(userId) && isValidUserSelfUpdate())
        || (isAdmin() && isValidAdminUserUpdate(userId));

      // Only super admins can delete users (soft delete preferred)
      allow delete: if isSuperAdmin();

      // Validate self-update (users can't change role, email, id)
      function isValidUserSelfUpdate() {
        let unchangedFields = ['id', 'email', 'role', 'masjidId', 'createdAt', 'createdBy',
                               'isFlagged', 'flaggedReason', 'flaggedAt', 'flaggedBy', 'flaggedByMasjid'];
        return request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(unchangedFields) == false;
      }

      // Validate admin update
      function isValidAdminUserUpdate(targetUserId) {
        // Super admins can update anything
        // Zakat admins can only update applicants
        return isSuperAdmin() || resource.data.role == 'applicant';
      }
    }

    // ============================================
    // MASAJID COLLECTION
    // ============================================
    match /masajid/{masjidId} {
      // Public read access for active masajid (for public listing page)
      // This allows unauthenticated users to view the masajid directory
      allow read: if true;

      // Only super admins can create/update/delete masjids
      allow create, update, delete: if isSuperAdmin();
    }

    // ============================================
    // APPLICATIONS COLLECTION
    // ============================================
    match /applications/{applicationId} {
      // Helper to get application data
      function getApplication() {
        return resource.data;
      }

      // Check if application is in the pool (submitted, not assigned)
      // Handles both: field not existing, or field explicitly set to null
      function isInPool() {
        return getApplication().status == 'submitted'
          && (!('assignedTo' in resource.data) || resource.data.assignedTo == null);
      }

      // Check if application is assigned to requesting admin
      function isAssignedToMe() {
        return getApplication().assignedTo == request.auth.uid;
      }

      // Applicants can read their own applications
      // Admins can read: submitted applications, applications assigned to them/their masjid, or all (super_admin)
      allow read: if isOwner(getApplication().applicantId)
        || isSuperAdmin()
        || (isZakatAdmin() && getApplication().status == 'submitted')
        || (isZakatAdmin() && isAssignedToMe())
        || (isZakatAdmin() && getApplication().assignedToMasjid == getUserMasjid());

      // Applicants can create applications for themselves
      allow create: if isAuthenticated()
        && request.resource.data.applicantId == request.auth.uid
        && request.resource.data.status == 'draft'
        && isValidApplicationStatus(request.resource.data.status);

      // Applicants can update their own draft applications
      // Applicants can submit their draft applications
      // Admins can update applications assigned to them or their masjid
      allow update: if (isOwner(getApplication().applicantId)
          && getApplication().status in ['draft', 'pending_documents']
          && isValidApplicantUpdate())
        || (isAdmin() && isValidAdminApplicationUpdate());

      // Only super admins can delete applications
      allow delete: if isSuperAdmin();

      // Validate applicant update
      function isValidApplicantUpdate() {
        // Applicants can only update form fields and submit
        // They cannot change: id, applicantId, assignedTo, adminNotes, resolution
        let protectedFields = ['id', 'applicantId', 'applicationNumber', 'assignedTo',
                               'assignedToMasjid', 'assignedAt', 'adminNotes', 'resolution', 'createdAt'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();

        // Check no protected fields are changed
        let noProtectedChanges = !changedFields.hasAny(protectedFields);

        // If status is changing, it must be from draft to submitted
        let validStatusChange = !changedFields.hasAny(['status']) ||
          (resource.data.status == 'draft' && request.resource.data.status == 'submitted');

        return noProtectedChanges && validStatusChange;
      }

      // Validate admin update
      function isValidAdminApplicationUpdate() {
        // Super admins can update anything
        // Zakat admins can:
        // 1. Claim from pool (status == submitted, setting assignedTo to themselves)
        // 2. Update if assigned to them
        // 3. Update if in their masjid

        // Simplified claiming check - only verify status is submitted and user is claiming for themselves
        // The client-side already validates that assignedTo is null before attempting claim
        let isClaimingFromPool =
          resource.data.status == 'submitted' &&
          request.resource.data.assignedTo == request.auth.uid;

        let isAssignedOrMasjid = isAssignedToMe() || isZakatAdminForMasjid(getApplication().assignedToMasjid);

        return isSuperAdmin() || isClaimingFromPool || isAssignedOrMasjid;
      }

      // Application history subcollection
      match /history/{historyId} {
        // Same read permissions as parent application
        allow read: if isOwner(get(/databases/$(database)/documents/applications/$(applicationId)).data.applicantId)
          || isAdmin()
          || isSuperAdmin();

        // Only admins can create history entries (or Cloud Functions via admin SDK)
        allow create: if isAdmin()
          && request.resource.data.performedBy == request.auth.uid;

        // History entries cannot be updated or deleted (immutable audit trail)
        allow update, delete: if false;
      }

      // Document requests subcollection
      match /documentRequests/{requestId} {
        // Same read permissions as parent
        allow read: if isOwner(get(/databases/$(database)/documents/applications/$(applicationId)).data.applicantId)
          || isAdmin();

        // Only admins can create document requests
        allow create: if isAdmin();

        // Applicants can update (mark as fulfilled), admins can update
        allow update: if isOwner(get(/databases/$(database)/documents/applications/$(applicationId)).data.applicantId)
          || isAdmin();

        // Only super admins can delete
        allow delete: if isSuperAdmin();
      }

      // Disbursements subcollection - tracks monthly/individual disbursements
      match /disbursements/{disbursementId} {
        // Applicants can view their own disbursements (using applicantId stored on document)
        // Admins can view all disbursements
        // Note: Using resource.data.applicantId for collectionGroup query compatibility
        allow read: if isAuthenticated()
          && (resource.data.applicantId == request.auth.uid || isAdmin());

        // Only admins can create disbursements (typically via Cloud Functions)
        allow create: if isAdmin()
          && request.resource.data.disbursedBy == request.auth.uid
          && request.resource.data.amount > 0;

        // Disbursements cannot be updated (immutable for audit trail)
        // Only super admins can make corrections
        allow update: if isSuperAdmin();

        // Only super admins can delete disbursements
        allow delete: if isSuperAdmin();
      }
    }

    // ============================================
    // FLAGS COLLECTION
    // ============================================
    match /flags/{flagId} {
      // Admins can read flags
      allow read: if isAdmin();

      // Only admins can create flags
      allow create: if isAdmin()
        && request.resource.data.flaggedBy == request.auth.uid
        && isValidFlagSeverity(request.resource.data.severity);

      // Only super admins or the flag creator can update
      // Zakat admins can only resolve their own flags
      allow update: if isSuperAdmin()
        || (isZakatAdmin() && resource.data.flaggedBy == request.auth.uid);

      // Only super admins can delete flags
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Only system (Cloud Functions) should create notifications
      // Using admin SDK bypasses rules
      allow create: if false;

      // Users can mark their own notifications as read
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);

      // Users can delete their own notifications
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AUDIT LOGS COLLECTION (System only)
    // ============================================
    match /auditLogs/{logId} {
      // Only super admins can read audit logs
      allow read: if isSuperAdmin();

      // Only Cloud Functions can write (uses admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // SYSTEM SETTINGS (Super Admin only)
    // ============================================
    match /settings/{settingId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // ============================================
    // COUNTERS COLLECTION (For application numbers)
    // ============================================
    match /counters/{counterId} {
      // Only admins can read counters
      allow read: if isAdmin();

      // Only Cloud Functions can write (uses admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // COLLECTION GROUP QUERIES
    // ============================================

    // Disbursements collection group - enables collectionGroup queries
    // for aggregating disbursements across all applications
    match /{path=**}/disbursements/{disbursementId} {
      // Applicants can view their own disbursements
      // Admins can view all disbursements
      allow read: if isAuthenticated()
        && (resource.data.applicantId == request.auth.uid || isAdmin());
    }

    // ============================================
    // DEFAULT: DENY ALL
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
